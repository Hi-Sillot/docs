// // 修改后的核心逻辑文件
// import type { BioChainMapItem, LocalMapItem, MapNodeLink, Page, TitleGetter } from "../types";
// import { fs, path } from "vuepress/utils";
// import { App } from "vuepress/core";
// import { options } from "./index";
// import { graphDataName } from "../client/useGlobalGraph";
// import { useBioChainStore } from "../../../stores/pinia-bio-chain";

// // 移除原全局对象，改为使用Pinia Store
// // export const bioChainMap: Record<string, BioChainMapItem> = {};

// 	/**
//  * 生成临时全局图谱文件（用于开发阶段实时访问）
//  * @param app VuePress 应用实例
//  * @returns 临时文件相对于项目根目录的路径
//  */
// export function writeTempGlobalGraph(app: App): string {
//   const store = useBioChainStore();
//   // 从 Store 获取全局图谱数据
//   const globalMap = store.getGlobalMap();
  
//   // 写入临时目录
//   const tempLocation = app.dir.temp(graphDataName);
//   fs.ensureDirSync(path.dirname(tempLocation));
//   fs.writeFileSync(tempLocation, JSON.stringify(globalMap), "utf-8");
 
//   // 计算相对于项目根目录的路径（供客户端导入使用）
//   const projectRoot = app.dir.source();
//   return path.relative(projectRoot, tempLocation);
// }

// export function buildBioChainMap(
//   pages: Page[],
//   titleGetter: TitleGetter = (page) => {
//     return page.title?.trim() || page.filePathRelative || '未命名';
//   }
// ): void {
//   const store = useBioChainStore();
//   const validPages = pages.filter(page => typeof page.filePathRelative === 'string');
  
//   // 初始化Store映射
//   // @ts-ignore
//   store.initializeMap(validPages.map(page => ({
//     filePathRelative: page.filePathRelative,
//     title: titleGetter(page)
//   })));

//   // 收集链接关系
//   const linkInfo: Array<{ source: string; target: string }> = [];
//   validPages.forEach(page => {
//     const sourcePath = page.filePathRelative!;
//     page.links.forEach(link => {
//       const targetPath = decodeURIComponent(link.relative);
//       if (store.getBioChainItem(targetPath)) {
//         linkInfo.push({ source: sourcePath, target: targetPath });
//       }
//     });
//   });

//   // 更新双向链接
//   store.updateLinks(linkInfo);

//   // 处理页面数据存储（替代原write_to_frontmatter）
//   validPages.forEach(page => {
//     const filePath = page.filePathRelative!;
//     const bioChain = store.getBioChainItem(filePath);
//     if (!bioChain) return;

//     // 去重处理
//     bioChain.outlink = [...new Set(bioChain.outlink)];
//     bioChain.backlink = [...new Set(bioChain.backlink)];

//     // 处理链接格式（.md -> .html）
//     const processLink = (link: string) => {
//       const parsed = path.parse(link);
//       return parsed.ext === '.md' 
//         ? path.format({ ...parsed, ext: '.html' }) 
//         : link;
//     };

//     // 生成输出数据
//     const outlinkResult = bioChain.outlink.map(link => ({
//       title: store.getBioChainItem(link)?.title || '未命名',
//       link: processLink(link)
//     }));

//     const backlinkResult = bioChain.backlink.map(link => ({
//       title: store.getBioChainItem(link)?.title || '未命名',
//       link: processLink(link)
//     }));

//     // 生成本地图谱（使用Store的action）
//     const localMap = store.generateLocalMap(filePath, options.localGraphDeep || 5);

//     // 存储到Store
//     store.setPageData(filePath, {
//       outlink: outlinkResult,
//       backlink: backlinkResult,
//       localMap: localMap
//     });
//   });
// }

// // 其他工具函数调整（示例）
// export async function writeGlobalGraph(app: App): Promise<void> {
//   const store = useBioChainStore();
//   const globalMap: MapNodeLink = { nodes: [], links: [] };

//   // 从Store获取全局数据
//   Object.keys(store.bioChainMap).forEach(path => {
//     const item = store.getBioChainItem(path)!;
//     globalMap.nodes.push({
//       id: path,
//       value: {
//         ...item,
//         path: path
//       },
//       linkCount: item.outlink.length + item.backlink.length
//     });

//     item.backlink.forEach(link => {
//       globalMap.links.push({ source: link, target: path });
//     });

//     item.outlink.forEach(link => {
//       globalMap.links.push({ source: path, target: link });
//     });
//   });

//   const location = app.dir.dest(graphDataName);
//   await fs.ensureDir(path.dirname(location));
//   await fs.writeFile(location, JSON.stringify(globalMap), "utf-8");
// }